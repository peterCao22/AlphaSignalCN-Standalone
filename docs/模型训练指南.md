# 模型训练指南

本指南说明如何定期重新训练二波预测模型，以利用最新数据和增强特征。

## 训练时机

建议在以下情况重新训练模型：

1. **定期训练**：每周或每两周（推荐周末）
2. **新增特征**：添加了新特征后（如增强特征）
3. **数据积累**：累积了大量新的交易样本（>500个新案例）
4. **准确率下降**：模型预测准确率明显下降

## 当前模型特征（共83个）⭐完整版⭐

**重大升级**: 发现 BigQuant `cn_stock_factors_ta` 实际有 **113个字段**，包含所有常用技术指标！

### 基础特征（4个）
- `consecutive_count`: 连板数
- `volume_ratio`: 量比
- `pct_change`: 涨跌幅
- `max_drawdown`: 最大回撤

### 移动平均线偏离度（5个）
- `bias_ma5`: 5日均线偏离度
- `bias_ma10`: 10日均线偏离度
- `bias_ma20`: 20日均线偏离度
- `bias_ma60`: 60日均线偏离度
- `bias_ma120`: 120日均线偏离度

### RSI 系列（4个）
- `rsi`: 14日RSI（标准）
- `rsi_6`: 6日RSI（短期）
- `rsi_12`: 12日RSI（中期）
- `rsi_24`: 24日RSI（长期）

### MACD 系列（3个）
- `macd`: MACD值
- `macd_dea`: DEA线（信号线）
- `macd_dif`: DIF线（快线）

### 布林带及衍生特征（5个）
- `boll_up`: 布林带上轨
- `boll_mid`: 布林带中轨
- `boll_down`: 布林带下轨
- `boll_position`: 价格在布林带中的相对位置（0-1）
- `boll_width_pct`: 布林带宽度百分比

### KDJ 指标（3个）
- `kdj_k`: K值
- `kdj_d`: D值
- `kdj_j`: J值

### CCI 指标（2个）
- `cci`: CCI顺势指标
- `cci_20`: 20日CCI

### 威廉指标（2个）
- `willr`: 威廉指标
- `willr_14`: 14日威廉指标

### 筹码特征（3个）
- `win_percent`: 获利盘比例
- `concentration`: 筹码集中度
- `price_to_cost`: 价格/成本比

### 龙虎榜特征（1个）
- `net_buy_amount`: 龙虎榜净买入额

### 市场情绪特征（3个）
- `sentiment_score`: 市场情绪分数
- `limit_up_count`: 涨停股票数
- `limit_up_real_count`: 真实涨停数（封板）

### 增强特征 - 热度（2个）
- `hotness_rank`: 热度排名
- `hot_duration`: 热度持续天数

### 增强特征 - 概念（5个）
- `concept_count`: 所属概念数量
- `concept_avg_gain`: 概念平均涨幅
- `concept_max_gain`: 概念最大涨幅
- `concept_momentum`: 概念动量
- `concept_resonance`: 概念共振度

### 增强特征 - 竞价（4个）
- `auction_volume_ratio`: 竞价量比
- `auction_price_gap`: 竞价价格缺口
- `auction_turnover`: 竞价换手率
- `auction_strength`: 竞价强度

## 训练前准备

### 1. 确保数据完整

检查以下数据文件是否存在且最新：

```bash
# 进入项目目录
cd d:\myCursor\AlphaSignalCN-Standalone

# 检查数据文件
dir data\historical_patterns.db          # 历史模式数据库（标签）
dir data\raw\kline\kline_*.csv          # K线数据
dir data\raw\ta_factors.csv             # 技术分析因子（MA、RSI等）⭐新增⭐
dir data\raw\chips_all.csv              # 筹码数据
dir data\raw\limit_up\dragon_list.csv   # 龙虎榜数据
dir data\market_sentiment.db            # 市场情绪数据
dir data\raw\hot_rank.csv               # 热度排名
dir data\raw\concept_component.csv      # 概念成分
dir data\raw\concept_bar.csv            # 概念行情
dir data\raw\auction_factors.csv        # 竞价因子
```

### 2. 确保有足够的训练样本

训练样本来自 `data/historical_patterns.db` 中的 `stock_patterns` 表。

**查看样本数量：**

```python
import sqlite3
import pandas as pd

conn = sqlite3.connect('data/historical_patterns.db')
df = pd.read_sql("SELECT COUNT(*) as count FROM stock_patterns", conn)
print(f"训练样本数量: {df['count'][0]}")

# 查看正负样本分布
df = pd.read_sql("SELECT second_wave_confirmed, COUNT(*) as count FROM stock_patterns GROUP BY second_wave_confirmed", conn)
print(df)
conn.close()
```

**建议**：至少需要 **200+ 个样本** 才能有效训练，理想情况下 **1000+ 个样本**。

### 3. 更新技术分析因子数据（推荐）

**新增**: 使用 BigQuant 的专业技术分析因子，比手动计算更准确：

```bash
# 使用 rqsdk 环境
conda activate rqsdk

# 下载技术分析因子（MA、RSI、MACD等）
cd d:\myCursor\AlphaSignalCN-Standalone
python scripts\download_ta_factors.py
```

**优势**:
- ✅ 专业计算，确保准确性
- ✅ 覆盖全市场，数据完整
- ✅ 避免本地重复计算，提升效率

### 4. 更新增强特征数据

如果距离上次下载超过一周，建议重新下载：

```bash
# 下载增强特征（热度、概念、竞价）
python scripts\download_enhanced_features.py
```

## 训练步骤

### 方法 1：直接运行训练脚本

```bash
# 激活环境
conda activate rqsdk

# 进入项目目录
cd d:\myCursor\AlphaSignalCN-Standalone

# 运行训练
python scripts\train_model.py
```

### 方法 2：在 Python 中逐步执行

```python
import sys
sys.path.insert(0, 'd:/myCursor/AlphaSignalCN-Standalone/scripts')

from train_model import SecondWaveModelTrainer

# 初始化训练器
trainer = SecondWaveModelTrainer()

# 准备特征（加载数据 + 特征工程）
data = trainer.prepare_local_features()

# 查看数据形状
print(f"训练数据: {data.shape}")
print(f"特征列: {data.columns.tolist()}")

# 训练模型
if data is not None:
    trainer.train(data)
```

## 训练输出

### 日志文件
训练日志保存在 `logs/train_model.log`

### 模型文件
训练完成后会生成以下文件：

```
models/
  ├── second_wave_lgb.model    # LightGBM 模型
  ├── second_wave_xgb.model    # XGBoost 模型
  └── feature_names.json       # 特征名称列表
```

### 评估指标

训练过程会输出：

- **LightGBM AUC**: LightGBM 模型的 AUC 分数
- **XGBoost AUC**: XGBoost 模型的 AUC 分数
- **Ensemble AUC**: 集成模型的 AUC 分数

**AUC 分数解读：**
- `0.90+`: 优秀
- `0.80-0.90`: 良好
- `0.70-0.80`: 一般
- `<0.70`: 需要优化特征或增加样本

## 训练后验证

### 1. 检查模型文件时间戳

```bash
dir models\*.model
```

确认文件是最新的（刚刚生成）。

### 2. 测试预测

```bash
# 测试单只股票预测
python predict_stock.py 300346
```

### 3. 对比新旧模型

可以先备份旧模型，然后对比预测结果：

```bash
# 备份旧模型
mkdir models\backup_20260114
copy models\*.model models\backup_20260114\
copy models\*.json models\backup_20260114\

# 训练新模型
python scripts\train_model.py

# 测试新模型
python predict_stock.py 300346
```

## 常见问题

### Q1: 训练时提示"标签数据为空"

**原因**: `data/historical_patterns.db` 不存在或为空。

**解决**:
```bash
# 运行模式分析脚本生成标签数据
python scripts\analyze_patterns.py
```

### Q2: 训练时提示"未找到K线数据"

**原因**: K线数据文件不存在。

**解决**:
```bash
# 使用 BigQuant 下载K线数据
# 或运行一次预测脚本，自动下载
python predict_stock.py 300346
```

### Q3: 训练时提示"加载增强特征失败"

**原因**: 增强特征数据文件缺失。

**解决**:
```bash
conda activate rqsdk
python scripts\download_enhanced_features.py
```

### Q4: AUC 分数很低（<0.60）

**可能原因**:
1. 训练样本太少（<200个）
2. 正负样本比例严重失衡
3. 特征缺失或质量差

**解决**:
1. 积累更多历史数据再训练
2. 检查数据完整性
3. 调整模型超参数

### Q5: 训练过程中内存不足

**解决**:
1. 关闭其他程序释放内存
2. 减少训练数据量（只保留最近1-2年的数据）
3. 使用更大内存的机器

## 最佳实践

1. **定期备份模型**: 每次训练前备份旧模型
2. **记录训练日志**: 保存每次训练的日期、AUC分数、样本数量
3. **A/B测试**: 新旧模型并行运行一段时间，对比效果
4. **数据质量检查**: 定期检查数据源的可用性和准确性
5. **参数调优**: 根据实际效果调整模型超参数

## 训练记录模板

```
训练日期: 2026-01-14
模型版本: v2.0
训练样本: 1500 条
正样本: 450 (30%)
负样本: 1050 (70%)
特征数量: 26
LightGBM AUC: 0.8542
XGBoost AUC: 0.8621
Ensemble AUC: 0.8605
备注: 新增14个增强特征
```

## 下次训练建议

建议在 **2026-01-21（下周二）** 或累积更多数据后重新训练。
