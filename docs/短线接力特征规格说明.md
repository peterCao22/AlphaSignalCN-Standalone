## 目标（本项目要解决什么）

本项目的定位是 **短线接力筛选器**：在涨停/异动当晚，筛选出**次日更容易被资金接力**、并且**更可能继续晋级/连板**的标的。

### 核心优化目标（离线评估口径）

- **次日接力胜率**（T+1）：次日是否能维持强势（不核按钮/不大幅回撤/不炸板后走弱）
- **晋级/续板概率**（T+1）：连板晋级、或至少次日出现有效溢价（强势高开/回封）
- **风控**：减少“尾盘烂板/多次开板/非主线无接力”等误判

> 注意：不是中长期涨幅预测，更接近“隔日环境与接力结构”的判断。

## 特征分层（按目标与边际收益）

### A. 核心层（必须有，强解释力）

#### A1. 板质量（最关键缺口）

用于解决“尾盘才封、盘中反复开板但评分很高”的反直觉问题。

- **首次封板时间**：`first_seal_time`
- **最终封板时间**：`last_seal_time`
- **开板次数**：`open_count` / `break_count`
- **封板时长**：`seal_duration_minutes`
- **封板质量分**：`board_quality_score`（可由上述字段加权合成）

数据源建议：

- Moma/智兔涨停池接口（若提供封板/开板字段）
- （参考字段示例）涨停池返回字段（不同接口/版本可能略有差异）：


| 字段    | 类型     | 含义               | 建议映射到特征                       |
| ----- | ------ | ---------------- | ----------------------------- |
| `cje` | number | 成交额（元）           | `amount`（或板质量权重/过滤）           |
| `lt`  | number | 流通市值（元）          | 流通盘/市值分组（可选）                  |
| `zsz` | number | 总市值（元）           | 市值分组（可选）                      |
| `hs`  | number | 换手率（%）           | `turnover_rate`（或板质量辅助）       |
| `lbc` | number | 连板数              | `consecutive_limit_ups`（口径自定） |
| `fbt` | string | 首次封板时间（HH:mm:ss） | `first_seal_time`             |
| `lbt` | string | 最后封板时间（HH:mm:ss） | `last_seal_time`              |
| `zj`  | number | 封板资金（元）          | `seal_fund_amount`（板质量增强项）    |
| `zbc` | number | 炸板次数             | `open_count` / `break_count`  |
| `tj`  | string | 涨停统计（x天/y板）      | 解析得到 `limit_up_count_*`（可选）   |


缺失处理：

- 缺字段时设为中性值，并在日志标注“板质量缺失”，避免模型把缺失当信号。

#### A2. 短周期板结构（把“5天3板”显式化）

用于解决“短线形态强，但模型只看连续连板”的错位。

- `limit_up_count_5d`：近5个有效交易日涨停次数
- `limit_up_count_10d`：近10个有效交易日涨停次数
- `max_consecutive_limit_up_10d`：近10日最长连板
- `days_since_last_limit_up`：距离上次涨停天数
- `gap_days_between_limit_ups`：两次涨停间隔（可选）

数据源：

- 日K（`kline_all`）中的 `pct_change/is_limit_up`（注意停牌日不应污染）

缺失处理：

- 停牌/无交易日：不计入“有效交易日窗口”。

#### A3. 主线题材匹配度（“有概念”不够，必须“在主线”）

用于解决“形态对但不在热点概念 → 没资金做”的情况。

- `theme_hit_count_topN`：命中当日Top热点概念数量（N建议20）
- `theme_best_rank`：命中概念的最好排名
- `theme_strength_score`：命中概念的涨幅/热度综合
- `is_main_theme`：是否命中TopN主线（0/1）

数据源建议：

- 同花顺“热门概念板块”爬取结果（你已接入）
- 股票→概念映射（BigQuant `cn_stock_index_concept_component` 或其他可靠来源）
- 概念指数成分：`[cn_stock_index_concept_component](https://bigquant.com/data/datasources/cn_stock_index_concept_component)`
- 行业成分（可用于“行业主线”补充）：`[cn_stock_industry_component](https://bigquant.com/data/datasources/cn_stock_industry_component)`

缺失处理：

- 若概念映射缺失：给 `theme_hit_count_topN=0`，并记录缺失率（防止系统性偏差）。

#### A4. 市场环境趋势（不是静态分，而是“退潮/升温”）

用于解决“昨天开始转弱、今天更差”的预判需求。

- `sentiment_score_t`：当日情绪分
- `sentiment_slope_2d/3d`：近2/3日情绪变化（斜率）
- `relay_env_score`：接力环境综合（续板率/炸板率/晋级率）
- `limit_up_real_count`：真实涨停数（环境热度）

数据源：

- LeguLegu 赚钱效应
- 指数日行情（用于大盘/风格环境，可选）：`[cn_stock_index_bar1d](https://bigquant.com/data/datasources/cn_stock_index_bar1d)`
- 自己统计：涨停池→次日晋级（建议后续落地）

缺失处理：

- 允许回退到最近可用日期（≤30天），但要记录“回退天数”作为特征之一。

#### A5. 资金结构（龙虎榜不只是净买入）

用于解决“龙虎榜很大但结构不对/对倒/一日游”等误判。

最小可行：

- `dragon_net_buy_amount`（已有）
- `dragon_occurrence_count_10d`：近10天上榜次数
- `dragon_buy_sell_skew`：买卖结构偏向（若字段可得）

升级目标（需要更详细字段/席位级数据）：

- 买方集中度、席位重合度（对倒识别）
- 机构/游资标签（增强项，非硬依赖）：
  - 常见可行路径是维护一份 **“席位/营业部 → 标签”映射表**（手工+持续更新），或接入第三方现成标签数据源。
  - 若短期难以维护，建议先不引入，避免把“标签缺失/不准”引入为噪声。

缺失处理：

- 无龙虎榜即中性，不应强行判负；弱市下可作为加分项而非硬门槛。

### B. 增强层（有帮助，但依赖数据质量与市场状态）

#### B1. 股性/量价（你已实现的 21 个特征）

用于补充“更偏好哪类票”的统计特征，但注意冗余与过拟合风险。

- 股性：`volatility_60d, limit_up_frequency, second_wave_history, amplitude_avg_60d, hot_stock_days, concept_rotation_count, rebound_speed`
- 量价：`volume_price_correlation, volume_increase_ratio, volume_price_divergence, shrink_limit_up, turnover_rate, volume_continuity, volume_pattern, volume_ma_ratio`
- A+B偏好：`up_day_ratio_60d, up_body_sum_ratio_60d(_log), net_body_strength_60d, up_volume_ratio_60d, up_amount_ratio_60d, turnover_trend_20d`

注意：

- 预测端要对停牌日做“有效交易日窗口”过滤（已处理）
- 训练端建议对极端值做 log/clip（你已开始做）

#### B2. TA 因子（精选）

建议只保留少量代表性 TA 因子，避免相关性堆叠：

- 少量均线/乖离、1-2组 MACD、1组 RSI、1组 BOLL、1组 ATR

### C. 冗余候选（可能有害，需消融验证）

这些容易造成噪声注入/过拟合/目标错位：

- 大量重复周期 TA（MA/EMA/WMA、多个 RSI 周期、多个 MACD 参数组全量引入）
- 长周期财务估值类（与“次日接力”目标错位）
- 缺失率很高且默认值固定的“伪特征”（会让模型学到“缺失=信号”）

## 数据质量规则（关键）

### 停牌/无交易日

典型：`open/high/low/close = NULL` 且 `volume = 0`（amount 可能 NULL）

处理原则：

- 不应参与 MA/量比/RSI 等滚动窗口
- 不应作为坏数据触发强制重拉
- 复牌首日应允许“窗口不足”，避免 NaN 传播

### 坏行（需要修复）

典型：

- `close IS NULL AND volume > 0`
- `close > 0 AND volume = 0`（需结合数据源确认）

处理原则：

- 触发强制重拉/覆盖写入（参见 `force_refresh_from` 机制）

## 评估与消融（防止越做越杂）

### 离线标签建议（围绕“接力/晋级”）

可选口径（从易到难）：

- T+1 是否晋级连板（涨停/大阳强势）
- T+1 最大回撤是否超过阈值（例如 -5%）
- T+1 是否有“有效溢价”（高开且不破关键位）

### 消融（Ablation）策略

按组移除对比：

- 仅核心层 A（板质量+主线匹配+情绪趋势+短周期板结构）
- A + 资金结构
- A + 股性/量价
- A + 精选TA
- 全量（对照）

观察：

- 次日接力胜率/晋级率是否提升
- 是否减少“烂板高分/主线强票低分”的错判

## 实施优先级（建议顺序）

1. **板质量因子（A1）**
2. **短周期板结构（A2）**
3. **主线题材匹配（A3）**
4. **情绪趋势/退潮（A4）**
5. **龙虎榜结构升级（A5）**

## 当前实现状态对照表（以预测链路为准）

下面这张表的目的不是“规划”，而是回答：**现在跑 `predict_stock.py`，哪些特征真的进入了 `features` 并影响 `rule_prob/ml_prob/final_prob`？**

### A层（核心层）现状


| 分组        | 关键特征                                                                           | 当前状态          | 当前实现位置                                                                                                                         | 依赖数据源/文件                                                                                                   |
| --------- | ------------------------------------------------------------------------------ | ------------- | ------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------- |
| A1 板质量    | `first_seal_time/last_seal_time/open_count/seal_fund_amount` 等                 | **未接入（待做）**   | 目前预测 `features` 中无此类字段                                                                                                         | 涨停池接口字段（如 `fbt/lbt/zbc/zj`），当前仅记录在本文档                                                                      |
| A2 短周期板结构 | 连板数/连续涨停天数、触发日选择                                                               | **部分接入**      | `scripts/pattern_matcher.py:get_stock_features()` 产出 `consecutive_count`；`predict_stock.py` 用 `is_limit_up` 找 `trigger_date`   | `data/raw/kline/kline_all.csv` → `predict_stock.py:process_kline()` → `data/temp/kline_processed_temp.csv` |
| A3 主线题材匹配 | 概念数量/主概念涨幅/概念动量                                                                | **部分接入**      | `scripts/enhanced_features_service.py` + `scripts/pattern_matcher.py`（`concept_count/main_concept_gain/concept_momentum_3d` 等） | `data/raw/concept_component.csv`、`data/raw/concept_bar.csv`                                                |
| A3（热点板块）  | 同花顺“热门概念板块”命中（目前仅龙头命中）                                                         | **弱接入（仅龙头）**  | `MarketSentimentService.get_stock_sector_info()` 目前只判断“是否为热门板块龙头”；尚未实现“股票→概念→TopN热点板块”的完整映射                                    | `data/market_sentiment.db` 的 `hot_sectors` 表（leader_stock_code）                                            |
| A4 市场环境趋势 | `market_sentiment_score/limit_up_real_count/median_gain_all/relative_strength` | **已接入（静态）**   | `scripts/pattern_matcher.py` 动态导入 `MarketSentimentService` 并写入 `features`                                                      | `data/market_sentiment.db` 的 `market_sentiment` 表（含回退逻辑）                                                   |
| A5 龙虎榜资金  | `net_buy_amount`                                                               | **已接入（最小可行）** | `scripts/pattern_matcher.py` 从 dragon_list 按 `symbol+date` 汇总                                                                  | `data/raw/limit_up/dragon_list.csv`（批量模式下 `predict_stock.py` 会先补最近30天）                                     |


### B层（增强层）现状


| 分组                | 关键特征                                                                                                                             | 当前状态             | 当前实现位置                                                                                                 | 依赖数据源/文件                                                                                                           |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------- | ---------------- | ------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------ |
| B1 热度/概念/竞价（增强特征） | `hot_rank/is_hot_stock/hot_duration`、`concept_count/main_concept_gain`、`auction_strength/auction_price_gap/auction_volume_ratio` | **已接入**          | `scripts/pattern_matcher.py` 调用 `EnhancedFeaturesService.get_all_features()`                           | `data/raw/hot_rank.csv`、`data/raw/concept_component.csv`、`data/raw/concept_bar.csv`、`data/raw/auction_factors.csv` |
| B1 股性/量价/A+B（21列） | `volatility_60d`…`turnover_trend_20d`                                                                                            | **已接入（方案A文件合并）** | `scripts/pattern_matcher.py` `_load_stock_character_features_for_date()` + 回退策略                        | `data/raw/features/features_kline_stock_character_*.csv`（由 `scripts/enhanced_stock_character_features.py` 生成）      |
| B2 TA 因子（精选/全量）   | 训练端大量 TA；预测端主要用 MA/RSI/量比/乖离                                                                                                     | **训练/预测口径不同**    | 预测端：`predict_stock.py:process_kline()` 产出 `ma*/rsi/volume_ratio`；训练端：`scripts/train_model.py` 合并 TA 因子 | 预测端：`kline_processed_temp.csv`；训练端：`data/raw/ta_factors.csv`（若存在）                                                  |


### C层（冗余候选）现状

当前没有把“长周期财务估值类”硬塞进预测链路（符合你“短线接力不需要估值”的约束）。

## 数据落盘位置速查（预测链路）

- **日K主文件**：`data/raw/kline/kline_all.csv`
- **预测临时K线（覆盖写）**：`data/temp/kline_processed_temp.csv`
- **筹码**：`data/raw/chips_all.csv`（或 `data/raw/chips*.csv` 最新文件）
- **龙虎榜**：`data/raw/limit_up/dragon_list.csv`（或 `data/raw/limit_up/dragon_list*.csv` 最新文件）
- **市场情绪DB**：`data/market_sentiment.db`
- **增强特征CSV**：`data/raw/hot_rank.csv`、`data/raw/concept_component.csv`、`data/raw/concept_bar.csv`、`data/raw/auction_factors.csv`
- **股性/量价特征文件**：`data/raw/features/features_kline_stock_character_*.csv`

## 训练/预测字段名对齐提醒（避免混淆）

- **预测端（`predict_stock.py`/`pattern_matcher.py`）**：使用 `hot_rank`（并衍生 `is_hot_stock` 等）。
- **训练端（`scripts/train_model.py`）**：`feature_cols` 里目前是 `hotness_rank`，而批量合并增强特征实际产出的是 `hot_rank`。
  - 现状：训练会因为“列不存在”而自动把 `hotness_rank` 丢出 `feature_cols`（不会报错，但会悄悄少用一个特征）。
  - 建议：后续统一命名（例如训练端也改用 `hot_rank`），并在训练日志里打印缺失特征列表做显式提醒。

