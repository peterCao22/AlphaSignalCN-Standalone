# 数据流程说明文档

## 📊 概述

本文档详细说明 `predict_stock.py` 脚本的数据加载、处理和异动日选择流程。

---

## 🔍 关键问题解答

### Q1: 为什么之前使用2025-12-29作为异动日，而不是2026-01-09？

**原因**：数据文件路径不一致导致的。

#### 问题根源

1. **数据补充保存路径** ✅ `data/processed/kline_processed.csv`
2. **数据加载读取路径** ❌ `data/raw/kline/kline_all.csv`（旧数据）

**结果**：虽然补充了最新数据，但加载时仍读取旧数据，导致：
- 最新数据日期：2025-12-31
- 找到的异动日：2025-12-29
- 无法预测2026-01-09之后的行情

#### 解决方案

修改 `fetch_local_data()` 和 `check_and_supplement_data()` 函数：

```python
# 现在的加载顺序（已修复）
kline_paths = [
    'data/processed/kline_processed.csv',  # 优先：补充后的最新数据 ✅
    'data/raw/kline/kline_all.csv'          # 备用：原始数据
]
```

**修复效果**：
- ✅ 成功读取最新数据到2026-01-09
- ✅ 正确选择2026-01-09作为参考异动日
- ✅ 可以预测未来的二波行情

---

## 📁 数据文件说明

### 1. K线数据文件

| 文件路径 | 用途 | 数据来源 | 更新方式 |
|---------|------|---------|---------|
| `data/raw/kline/kline_all.csv` | 原始K线数据 | BigQuant初始下载 | 手动/一次性 |
| `data/processed/kline_processed.csv` | **补充后的K线** | MomaAPI增量补充 | 自动追加 |
| `data/processed_temp/kline_processed_{symbol}.csv` | 临时处理文件 | 从上述文件过滤 | 每次分析生成 |

**关键字段**：
- 必需：`date`, `instrument`, `open`, `high`, `low`, `close`, `volume`
- 可选：`adjust_factor`（用于前复权计算，补充数据无此字段）

### 2. 涨停数据文件

| 文件路径 | 用途 | 数据来源 | 更新方式 |
|---------|------|---------|---------|
| `data/raw/limit_up/limit_up_history.csv` | 原始涨停历史 | BigQuant初始下载 | 手动/一次性 |
| `data/raw/limit_up/limit_up_history_supplement.csv` | **补充涨停数据** | MomaAPI增量补充 | 自动追加 |

**注意**：涨停数据**不用于选择异动日**，仅用于特征提取中的 `is_limit_up` 字段。

### 3. 龙虎榜数据文件

| 文件路径 | 用途 | 数据来源 | 更新方式 |
|---------|------|---------|---------|
| `data/raw/limit_up/dragon_list.csv` | 原始龙虎榜 | BigQuant初始下载 | 手动/一次性 |
| `data/raw/limit_up/dragon_list_supplement.csv` | **补充龙虎榜** | Tonghuashun爬虫 | 自动追加 |

**关键字段**：
- `date`, `instrument`, `stock_code`
- `net_buy_amount`, `buy_amount`, `sell_amount`（资金流向）
- `reason`（上榜原因）

### 4. 筹码数据文件

| 文件路径 | 用途 | 数据来源 | 更新方式 |
|---------|------|---------|---------|
| `data/raw/chips_all.csv` | 筹码分布数据 | BigQuant初始下载 | 手动/一次性 |

**关键字段**：
- `win_percent`（获利盘比例）
- `concentration`（筹码集中度）
- `avg_cost`（平均成本）

**注意**：目前筹码数据**无自动补充**，使用历史数据。

---

## 🔄 完整数据流程

### 阶段1：数据检查与补充

```
1. 检查K线数据
   ├─ 优先检查: data/processed/kline_processed.csv
   ├─ 备用检查: data/raw/kline/kline_all.csv
   └─ 判断条件:
       ├─ 数据量: ≥60天（计算指标需要）
       └─ 新鲜度: 距今≤5天（考虑周末）

2. 触发补充条件
   ├─ 文件不存在
   ├─ 数据量不足
   └─ 数据过时

3. 执行补充
   ├─ K线数据
   │   ├─ API: MomaAPI
   │   ├─ 日期: 从最新日期-10天到今天
   │   └─ 保存: data/processed/kline_processed.csv（追加）
   │
   ├─ 龙虎榜数据
   │   ├─ 爬虫: Tonghuashun
   │   ├─ 日期: 与K线相同范围
   │   └─ 保存: data/raw/limit_up/dragon_list_supplement.csv（追加）
   │
   └─ 合并去重: 按date+instrument去重，保留最新数据
```

### 阶段2：数据加载

```
1. 加载K线数据
   ├─ 路径优先级:
   │   ├─ 1️⃣ data/processed/kline_processed.csv（最新）
   │   └─ 2️⃣ data/raw/kline/kline_all.csv（备用）
   │
   └─ 过滤: df[df['instrument'] == symbol]

2. 加载筹码数据
   └─ 路径: data/raw/chips_all.csv

3. 加载龙虎榜数据
   ├─ 路径优先级:
   │   ├─ 1️⃣ data/raw/limit_up/dragon_list.csv
   │   └─ 2️⃣ data/raw/limit_up/dragon_list_supplement.csv
   │
   └─ 策略: 找到任意一个有数据的文件即可
```

### 阶段3：技术指标计算

```python
def process_kline(df):
    # 1. 前复权处理
    if 'adjust_factor' in df.columns:
        # 原始数据有adjust_factor
        df['{col}_qfq'] = df[col] / latest_factor
    else:
        # 补充数据已是前复权，直接使用
        df['{col}_qfq'] = df[col]
    
    # 2. 计算均线
    df['ma5'] = df['close_qfq'].rolling(5).mean()
    df['ma10'] = df['close_qfq'].rolling(10).mean()
    df['ma20'] = df['close_qfq'].rolling(20).mean()
    df['ma60'] = df['close_qfq'].rolling(60).mean()
    
    # 3. 计算量比
    df['volume_ratio'] = df['volume'] / df['v_ma5'].shift(1)
    
    # 4. 计算RSI
    # ...
    
    # 5. 标记涨停
    df['is_limit_up'] = df['pct_change'] >= limit_threshold
```

### 阶段4：异动日选择

```python
# 关键代码（predict_stock.py:229-237）
triggers = df_processed[
    df_processed['is_limit_up'] |  # 涨停
    (df_processed['pct_change'] > 7)  # 或大涨>7%
].tail(5)  # 取最近5个异动日

if triggers.empty:
    trigger_date = df_processed['date'].iloc[-1]  # 没有异动，用最后交易日
else:
    trigger_date = triggers['date'].iloc[-1]  # 取最近的异动日
```

**判断依据**：
- ✅ K线数据中的 `pct_change`（涨跌幅）
- ✅ 计算出的 `is_limit_up`（是否涨停）
- ❌ **不直接使用** `limit_up_history.csv`

**为什么000987选择2026-01-09**：
- 2026-01-09涨跌幅：9.99%（>7%）✅
- 满足异动条件
- 是最近的异动日

---

## 🐛 常见问题排查

### 问题1：异动日选择不正确

**症状**：明明有新的涨停，但选择的是旧日期

**排查步骤**：
1. 检查K线数据最新日期
   ```python
   df = pd.read_csv('data/processed/kline_processed.csv')
   print(df['date'].max())  # 应该是最近几天
   ```

2. 检查涨跌幅计算
   ```python
   df['pct_change'] = df['close'].pct_change() * 100
   print(df[df['pct_change'] > 7].tail())  # 查看大涨日期
   ```

3. 检查数据加载路径
   - 确认 `fetch_local_data()` 使用的是 `kline_processed.csv`

### 问题2：数据补充失败

**症状**：提示数据过时，但补充后仍然过时

**排查步骤**：
1. 检查API密钥
   ```bash
   # .env文件中
   MOMA_API_KEY=你的密钥
   ```

2. 检查网络连接
   ```python
   # 查看日志
   [INFO] Successfully fetched XX kline records
   ```

3. 检查文件写入权限
   ```python
   # 确认文件被更新
   import os
   print(os.path.getmtime('data/processed/kline_processed.csv'))
   ```

### 问题3：特征值异常

**症状**：RSI=0, win_percent=0, concentration=0

**原因**：
- 筹码数据缺失（`chips_all.csv`无该股票）
- 数据列名不匹配
- 数据类型转换失败

**解决**：
- 检查原始文件是否有该股票数据
- 查看日志中的warning信息

---

## 📊 数据字段对照表

### K线数据必需字段

| 字段名 | 类型 | 说明 | 备注 |
|-------|------|------|------|
| `date` | datetime | 交易日期 | YYYY-MM-DD |
| `instrument` | string | 股票代码 | 000987.SZ格式 |
| `open` | float | 开盘价 | 前复权价 |
| `high` | float | 最高价 | 前复权价 |
| `low` | float | 最低价 | 前复权价 |
| `close` | float | 收盘价 | 前复权价 |
| `volume` | float | 成交量 | 手 |
| `amount` | float | 成交额 | 元 |

### 补充字段（可选）

| 字段名 | 类型 | 说明 | 来源 |
|-------|------|------|------|
| `adjust_factor` | float | 复权因子 | BigQuant原始数据 |
| `is_suspended` | bool | 是否停牌 | MomaAPI |
| `change_pct` | float | 涨跌幅% | MomaAPI |
| `pre_close` | float | 前收盘价 | MomaAPI |
| `stock_code` | string | 6位代码 | 补充数据 |

---

## 🎯 最佳实践

### 1. 定期维护

```bash
# 每周运行一次，补充最近的数据
cd d:/myCursor/AlphaSignalCN-Standalone
python scripts/supplement_layer3_data.py --days 7 --types kline dragon_list
```

### 2. 批量分析前

```bash
# 确保市场情绪数据最新
cd ../../
python scripts/update_market_sentiment.py
```

### 3. 数据验证

```bash
# 检查数据完整性
python scripts/validate_data.py --symbol 000987
```

---

## 🔧 配置优化建议

### 1. 数据新鲜度阈值

```python
# predict_stock.py:158
days_old_threshold = 5  # 可调整为3（更严格）或7（更宽松）
```

### 2. 异动日判断条件

```python
# predict_stock.py:230
triggers = df_processed[
    df_processed['is_limit_up'] |       # 涨停
    (df_processed['pct_change'] > 7)   # 可调整为5或9
].tail(5)  # 可调整为3或10
```

### 3. 数据补充范围

```python
# predict_stock.py:175
start_date = (latest_date - timedelta(days=10)).strftime('%Y-%m-%d')
# 可调整为5天（节省API调用）或20天（更保守）
```

---

## 📝 总结

### 核心要点

1. **数据路径**：优先使用 `processed` 目录下的补充数据
2. **异动日选择**：基于K线数据的涨跌幅，不依赖涨停文件
3. **数据新鲜度**：距今≤5天为合格
4. **自动补充**：检测到过时数据自动触发补充

### 已解决的问题

- ✅ 数据路径不一致
- ✅ 异动日选择逻辑
- ✅ 前复权数据兼容
- ✅ 市场情绪数据回溯

### 未来优化方向

1. 增加数据完整性检查
2. 支持更多数据源
3. 优化批量补充性能
4. 添加数据质量评分

---

**文档版本**：v1.0  
**最后更新**：2026-01-10  
**维护者**：StockAiNews Team

