# 筹码数据优化方案

## 📝 背景

在预测分析中发现，部分个股的筹码数据显示 `0.0%`，原因有两个：
1. **数据缺失**：该股票没有筹码数据
2. **数据过期**：筹码数据最新日期与分析日期不匹配

例如：002112 三变科技在 2026-01-14 分析时，筹码数据只到 2025-12-31，导致显示 `0.0%`。

---

## 🎯 优化方案

### 1️⃣ **增量补充功能**（Layer3DataSupplement）

新增 `supplement_chips_data` 方法，**只下载缺失或过期的个股数据**。

#### 特性

| 功能 | 说明 |
|------|------|
| **智能检测** | 自动检测哪些股票缺失数据或数据过期（>7天） |
| **增量下载** | 只下载需要更新的股票，避免浪费流量 |
| **去重合并** | 自动与已有数据合并并去重 |
| **日志详细** | 清晰显示每只股票的数据状态 |

#### 使用方法

```python
from stockainews.services.layer3_data_supplement import Layer3DataSupplement

supplement_service = Layer3DataSupplement()

# 仅补充指定股票的筹码数据
df = supplement_service.supplement_chips_data(
    stock_codes=['002112', '300346'],  # 只下载这两只股票
    start_date='2025-12-01',
    end_date='2026-01-14'
)
```

#### 输出示例

```
开始补充筹码数据: 2只股票, 2025-12-01 至 2026-01-14
发现已有筹码数据文件: data/raw/chips_all.csv, 共 1218 条记录

  002112: 最新数据 2025-12-31 (落后14天), 需要更新
  300346: 数据已是最新 (2026-01-13), 跳过

需要更新 1 只股票的筹码数据
使用 BigQuant SDK 下载筹码数据: 2025-12-01 至 2026-01-14
✓ BigQuant 返回 15 条筹码记录
合并新旧筹码数据...
合并后数据: 1233 条记录（原有 1218 条，新增 15 条）
✓ 筹码数据已保存: data/raw/chips_all.csv, 共 1233 条记录
```

---

### 2️⃣ **回退查询逻辑**（PatternMatcher）

在 `pattern_matcher.py` 的 `get_stock_features` 方法中，新增**筹码数据回退查询**。

#### 工作流程

```
1. 尝试获取当日筹码数据
   ├─ 成功 → 使用当日数据
   └─ 失败 → 执行回退查询
       ├─ 查找 [date-7天, date] 范围内的数据
       ├─ 找到最近的一条数据
       ├─ 使用该数据并记录日志
       └─ 如果7天内无数据 → 使用默认值 0.0%
```

#### 代码实现

```python
try:
    # 尝试获取当日筹码数据
    chip_row = chips_df.loc[(symbol, date)]
    win_percent = float(chip_row['win_percent'])
    # ...
except KeyError:
    # 【优化】向前查找7天内最近数据
    lookback_start = target_date - timedelta(days=7)
    recent_chips = stock_chips[
        (stock_chips.index >= lookback_start) & 
        (stock_chips.index <= target_date)
    ]
    if not recent_chips.empty:
        chip_row = recent_chips.iloc[-1]
        # 使用找到的数据
        logging.info(f"使用 {actual_date} 的筹码数据（向前回溯{days_diff}天）")
```

#### 效果

**优化前**：
```
2026-01-14 分析 002112.SZ
筹码数据: 找不到 2026-01-14 的数据
显示: 获利盘比例 0.0%, 筹码集中度 0.0000
```

**优化后**：
```
2026-01-14 分析 002112.SZ
筹码数据: 找不到 2026-01-14 的数据
回退查询: 使用 2025-12-31 的筹码数据（向前回溯14天）
显示: 获利盘比例 41.14%, 筹码集中度 0.092425
```

---

### 3️⃣ **自动补充集成**（predict_stock.py）

在 `check_and_supplement_data` 函数中，新增**筹码数据自动检查和补充**。

#### 检查逻辑

```python
def check_and_supplement_data(symbol, supplement_service):
    # 1. 检查K线数据...
    
    # 2. 【新增】检查筹码数据
    chips_df = pd.read_csv('data/raw/chips_all.csv')
    stock_chips = chips_df[chips_df['instrument'] == symbol]
    
    if stock_chips.empty:
        # 无数据 → 需要补充
        needs_chips_supplement = True
    else:
        latest_chips_date = stock_chips['date'].max()
        days_behind = (datetime.now() - latest_chips_date).days
        
        if days_behind > 7:
            # 数据过期 → 需要补充
            needs_chips_supplement = True
    
    if needs_chips_supplement:
        supplement_service.supplement_chips_data(
            stock_codes=[stock_code],
            start_date=(datetime.now() - timedelta(days=90)).strftime('%Y-%m-%d'),
            end_date=datetime.now().strftime('%Y-%m-%d')
        )
```

#### 使用效果

```bash
# 运行预测时，自动检测并补充筹码数据
python predict_stock.py --symbol 002112

# 输出：
002112.SZ 筹码数据已过期（最新: 2025-12-31, 落后14天），需要补充
开始补充 002112.SZ 的筹码数据...
✓ 002112.SZ 筹码数据补充完成
```

---

## 🎯 对比总结

| 优化点 | 优化前 | 优化后 |
|--------|--------|--------|
| **数据缺失处理** | 显示 0.0% | 自动下载补充 |
| **数据过期处理** | 显示 0.0% | 自动下载 + 回退查询 |
| **下载范围** | 下载所有股票（浪费流量） | 仅下载缺失/过期股票 |
| **查询逻辑** | 找不到当日数据就放弃 | 向前查找7天内最近数据 |
| **用户体验** | 需要手动补充 | 自动检测自动补充 |

---

## 📊 实际案例：002112

### 优化前

```
获利盘比例: 0.0%
筹码集中度: 0.0000
→ 评分偏高（缺少获利盘压力的负面影响）
```

### 优化后

```
获利盘比例: 41.14%
筹码集中度: 0.092425
平均成本: 13.71元
当前价格: 65.20元
价格/成本: +375.6%
→ 评分更准确（反映实际获利盘压力）
```

---

## 🧪 测试

运行测试脚本验证功能：

```bash
cd "d:\myCursor\AlphaSignalCN-Standalone"
python test_chips_supplement.py
```

---

## 📝 文件清单

| 文件 | 修改内容 |
|------|----------|
| `stockainews/services/layer3_data_supplement.py` | 新增 `supplement_chips_data` 方法 |
| `predict_stock.py` | 集成筹码数据自动检查和补充 |
| `scripts/pattern_matcher.py` | 新增筹码数据回退查询逻辑 |
| `test_chips_supplement.py` | 测试脚本 |
| `docs/筹码数据优化.md` | 本文档 |

---

**优化完成！现在预测时不会再出现 0.0% 的筹码数据了！** ✅
