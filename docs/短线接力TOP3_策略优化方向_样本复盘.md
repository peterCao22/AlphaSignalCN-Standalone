## 短线接力 TOP3：策略优化方向与样本复盘（滚动持仓/防 A 杀）

### 背景与目标
- **当前回测口径**（BigTrader 日线撮合）：信号日 D 收盘后下单，D+1 开盘买；买入成交日起算持有 N 个交易日，到期开盘卖。
- **当前组合执行**：N=5；为实现滚动持仓，采用“**每日新开 20% 仓位**，当天 TOP3 等分（每只约 6.67%）”。
- **问题**：5 日硬拿在“情绪退潮 / A 杀”阶段容易扩大回撤；同时模型会把部分“低位首板一字”判成高质量二波，导致进入 TOP3。
- **目标**：建立一套“可解释、可迭代、可回测”的优化清单，让模型在不同市场阶段更稳，尤其减少 A 杀期间的大回撤样本。

---

### 典型样本：`600173.SH`（触发日：2025-01-06）

#### 样本现象（用户复盘结论）
- 2025-01-06 出现 **缩量一字涨停**（首板），处于 **低位**，前面连续回撤。
- 之后进入典型的 **A 杀** 阶段：即使开盘强势（高开接近涨停），5 日持有仍可能被后续回撤吃掉。
- 直觉判断：该位置“上方套牢盘/筹码压力”与“洗盘概率”较大，**不适合 5 日硬拿**，或者至少需要更强的风控/环境过滤。

#### 样本特征（摘录）
- **位置/动量**：`pre_position="低位"`，`rsi≈31.54`，`days_since_last_limit_up=178`
- **一字/缩量**：`shrink_limit_up=1.0`，`volume_ratio≈0.49`，`board_first_seal_time="09:25:02"`，`board_quality_score≈85`
- **环境/题材**：`is_hot_sector=false`，`market_sentiment_level_label="中性"`；`index_has_data=false`（疑似缺失/回退）
- **模型打分**：`pattern_success_rate=0.9`，`sample_size=10`，`ml_prob≈0.763`，`final_prob≈0.725`

#### 初步解释（为什么会进 TOP3）
- “低位沉寂很久 + 首板一字 + 封单质量好”在很多历史样本中被当成“二波启动”模板，因此模型容易给高分。
- `pattern_success_rate` 高但 `sample_size=10`，容易出现**小样本高置信度**的错觉（需要做置信度惩罚）。
- 环境/指数/题材字段出现缺失/回退（例如 `index_has_data=false`），导致“退潮过滤器”失效或权重不足。

---

## 优化方向 1：一字板过滤/降权（把“缩量一字”从强信号变成风险信号）

### 目的
降低“低位首板一字”在 5 日滚动持仓下的回撤贡献，减少 A 杀阶段的踩雷。

### 适用范围（建议）
- **优先用于：持有 ≥3 日**（尤其 5 日滚动）口径；
- **对 1 日持有**可以更宽松（因为风险暴露窗口更短）。

### 可落地规则（候选）
以下规则均可做成“剔除”或“降权”两种模式：
- **规则 A（低位首板一字风险）**：
  - 条件示例：`pre_position="低位"` 且 `consecutive_count==1` 且 `shrink_limit_up==1`
  - 处理：`final_prob` 乘以折扣（如 0.6~0.8）或直接剔除
- **规则 B（极低换手/极低成交额）**（更贴近“筹码/流动性风险”）：
  - 条件示例：`turnover_rate` 很低（例如 <1%）或 `board_turnover_rate` 很低
  - 处理：降权或剔除
- **规则 C（小样本模板降权）**：
  - 条件示例：`sample_size < 30`（或 <50）
  - 处理：对 `pattern_success_rate` 或 `final_prob` 做惩罚（如乘 \(\sqrt{sample\_size/50}\) 的上限截断版本）

### 评估方式（回测验收）
- 对比：启用/不启用过滤器的
  - **最大回撤**、尾部损失（最差批次/最差单票）
  - **胜率/盈亏比**、以及“被过滤掉的票”是否集中在 A 杀期

---

## 优化方向 2：退潮环境过滤（情绪开关/仓位开关）

### 目的
把“个股强但环境差”的情形过滤掉；或在退潮期主动降仓，避免 5 日持有暴露在系统性回撤中。

### 核心思想
同样的形态（例如首板一字/强封单）在不同市场阶段的期望收益差别极大：
- **情绪上升/主线强势**：一字/强封更容易走出二波/连板
- **退潮/A 杀**：强封更可能成为出货或隔日回撤起点

### 可落地指标（候选）
- **市场情绪**（全市场）：
  - 最近 N 日 **涨停家数**、**连板高度**、**炸板率**（若数据可得）
  - 你的现有字段里可先用：`market_sentiment_score`、`market_sentiment_level`、`sentiment_slope_2d/3d`、`sentiment_fallback_days`
- **指数趋势**（大盘/风格）：
  - 指数是否站上 MA（`index_above_ma5/10/20`）、指数收益（`index_ret_1d/3d/5d`）
  - 注意：若出现 `index_has_data=false` / `index_fallback_days=999`，应视为“环境信号不可用”，需要降权或保守处理
- **题材/板块强度**（主线）：
  - `is_hot_sector`、`sector_rank`、`sector_gain`、`is_sector_leader`、`sector_capital_inflow`
  - 若 `sector_rank=999` 且其它字段为 0，通常也是缺失/回退，需谨慎

### 可落地规则（候选）
- **规则 D（退潮期降仓）**：
  - 条件示例：`market_sentiment_level` 低于阈值（如 ≤2）或 `sentiment_slope_3d < 0`
  - 处理：降低每日新开仓位（例如从 20% 降到 10% 或 0%）
- **规则 E（退潮期禁做一字/禁做低位首板一字）**：
  - 条件示例：退潮期开关触发 AND `shrink_limit_up==1`（或 AND `pre_position="低位" & consecutive_count==1`）
  - 处理：直接剔除该类票
- **规则 F（环境数据缺失则保守）**：
  - 条件示例：`index_has_data=false` 或 `sentiment_fallback_days` 很大
  - 处理：对 `final_prob` 乘以折扣（如 0.7），或把仓位减半

### 评估方式（回测验收）
- 把回测按市场阶段切片对比（上升/震荡/退潮），关注：
  - **退潮阶段的回撤**是否显著收敛
  - **信号命中率**在不同阶段是否更稳定（减少极端亏损批次）

---

## 优化方向 3：退出规则改造（避免 5 日硬拿被 A 杀吃掉）

### 目的
在日线数据权限约束下，仍然把“遇到明显走弱”时的风险快速收敛，减少尾部损失（尤其是 A 杀阶段）。

### 可落地规则（候选，日线可实现）
- **规则 G（缩短持有期对照组）**：
  - 对照：持有 2 日 / 3 日 / 5 日三组同时回测，找最优的风险收益比
- **规则 H（大阴线/跌破均线止损）**：
  - 条件示例：收盘跌幅 < -X%（如 -5%），或收盘跌破 MA5/MA10
  - 处理：在当日收盘后下单，次日开盘卖出（符合日线撮合时序）
- **规则 I（“跌破买入成本”保护）**（简化版）
  - 条件示例：收盘价低于成本价超过阈值（如 -3% / -5%）
  - 处理：次日开盘退出（需在回测里能取到持仓成本/可用字段）

### 注意事项
- 日线回测无法模拟“盘中触发”，所以所有触发都是“收盘后判定、次日开盘执行”，与实盘会存在偏差；但可用于稳定性筛选和规则方向验证。

---

## 迭代与复盘流程（建议固定化）
- **Step 1**：每次回测后，按批次/按单票输出“贡献最大盈利/最大亏损”的 Top N 列表
- **Step 2**：对 Top N 逐一填充“样本复盘模板”（位置、是否一字、换手、题材、环境、成交执行、亏损原因）
- **Step 3**：挑选 1~2 条最有效的规则做 A/B 回测（只改一个因素，避免混淆）
- **Step 4**：沉淀到模型：将过滤器从“硬规则”逐步转成“特征惩罚/权重学习”

---

### 待补充（后续数据准备）
- “上方套牢盘/筹码分布压力”的量化代理：例如成本分布、筹码峰、压力位距离等（需要明确数据源）
- 更可靠的“退潮指标”：涨停/连板/炸板等全市场统计（需确认 BigQuant 数据或本地统计口径）
