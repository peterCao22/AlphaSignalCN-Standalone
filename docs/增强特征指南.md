# 增强特征使用指南

## 📌 概述

本指南介绍如何使用**阶段1增强特征**（热度排名、概念板块、集合竞价因子）来提升二波潜力分析的准确率。

## 🎯 新增特征

### 1. 热度排名特征（cn_stock_hot_rank）

**数据来源**: BigQuant 个股热度排名

**核心特征**:
- `hot_rank`: 个股热度排名（1-999，999表示未上榜）
- `hot_rank_change`: 排名变化（正值=排名上升）
- `is_hot_stock`: 是否热门股（TOP100）
- `hot_duration`: 持续热门天数

**评分逻辑**:
- TOP10 热股: +25分
- TOP30 热股: +15分
- TOP100 热股: +10分
- 持续热门5天以上: +15分
- 持续热门3-4天: +10分

**应用场景**: 
市场关注度高的股票通常有更好的流动性和资金承接，二波概率更高。

---

### 2. 概念板块特征（cn_stock_index_concept_*）

**数据来源**: BigQuant 概念成分股 + 概念指数行情

**核心特征**:
- `concept_count`: 所属概念数量
- `main_concept_gain`: 主概念涨幅
- `main_concept_rank`: 主概念排名
- `is_concept_leader`: 是否概念龙头
- `concept_momentum_3d`: 概念3日动量
- `concept_volume_ratio`: 概念成交量比

**评分逻辑**:
- 多题材（5个以上概念）: +15分
- 多题材（3-4个概念）: +10分
- 主概念涨幅 > 5%: +20分
- 主概念涨幅 > 3%: +15分
- 概念3日动量 > 10%: +20分
- 概念3日动量 > 5%: +10分

**应用场景**: 
题材催化是A股短线的重要驱动力，多题材、强概念的股票二波潜力更大。

---

### 3. 集合竞价因子（cn_stock_factors_auction）

**数据来源**: BigQuant 集合竞价因子

**核心特征**:
- `auction_volume_ratio`: 竞价成交量/日均量
- `auction_price_gap`: 竞价价格偏离（%）
- `auction_turnover`: 竞价换手率
- `auction_strength`: 竞价强度（综合指标，0-100）

**评分逻辑**:
- 竞价强度 > 80（极强）: +30分
- 竞价强度 > 70（强）: +20分
- 竞价强度 > 60（良好）: +10分
- 高开3%以上 + 量比 > 2: +25分（量价配合）

**应用场景**: 
强势股的集合竞价往往表现出放量高开的特征，预示开盘后可能继续上涨。

---

### 4. 三重共振加成

**触发条件**:
- 是热门股（TOP100）
- 至少3个概念题材
- 竞价强度 > 70

**加成**: +40分

**逻辑**: 热度、题材、资金三重共振的股票，往往是市场的焦点，二波潜力极高。

---

## 🛠️ 使用流程

### Step 1: 下载数据

运行数据下载脚本：

```bash
cd d:/myCursor/StockAiNews/TradingAgents-chinese-market/AlphaSignal-CN
python scripts/download_enhanced_features.py
```

**输出**: 
- `data/raw/hot_rank.csv`
- `data/raw/concept_component.csv`
- `data/raw/concept_bar.csv`
- `data/raw/auction_factors.csv`

**智能增量下载**: 
- ✅ **自动检测已有数据**：脚本会读取已存在文件的最新日期
- ✅ **只下载新数据**：仅获取最新日期之后的数据，避免重复下载
- ✅ **自动去重合并**：新旧数据智能合并，去除重复记录
- ✅ **自动数据清理**：
  - 热度排名/概念行情：保留最近90天（用于计算趋势）
  - 概念成分股：保留最近7天（仅需映射关系）
  - 竞价因子：保留最近30天（仅需最近数据）

**首次运行**：
- 热度排名：下载90天
- 概念成分股：下载7天
- 概念行情：下载90天
- 竞价因子：下载30天

**后续运行**：
- 检查到已有数据后，只下载新增日期的数据
- 例如：数据最新到 2026-01-10，运行时会只下载 2026-01-11 之后的数据

---

### Step 2: 测试增强特征服务

运行测试脚本：

```bash
cd scripts
python enhanced_features_service.py
```

这将测试增强特征服务是否能够正确加载数据和提取特征。

---

### Step 3: 运行预测

增强特征已自动集成到 `predict_stock.py` 中，直接运行即可：

```bash
# 分析单只股票
python predict_stock.py --symbol 002202

# 分析昨日涨停股票池
python predict_stock.py
```

---

## 📊 特征权重总结

### 评分体系更新（Phase 4.1）

**原有特征**（最高150分）:
- 连板数: 20分/板
- 量比（1.5-3.0）: +20分
- 低位: +10分
- 筹码集中/获利盘高: +25分
- 龙虎榜净买入: +10~50分
- 热门板块: +20~30分
- 板块龙头: +15分
- 市场情绪: +15~25分
- 相对强度: +20分
- 资金+板块共振: +30分

**新增特征**（新增100分）:
- 热度排名: +10~25分
- 持续热门: +10~15分
- 多题材: +10~15分
- 概念涨幅: +15~20分
- 概念动量: +10~20分
- 竞价强度: +10~30分
- 量价配合: +25分
- 三重共振: +40分

**总上限**: 250分（Phase 4.1）

---

## 🎯 最佳实践

### 1. 数据更新频率

- **热度排名**: 每周更新（90天滚动窗口）
- **概念成分股**: 每月更新（映射关系变化不频繁）
- **概念行情**: 每周更新（90天滚动窗口）
- **竞价因子**: 每日更新（建议盘前获取最近30天）

**建议**: 设置定时任务，每周末运行一次 `download_enhanced_features.py` 即可。

### 2. 特征缺失处理

如果某个数据源暂时无法获取，系统会使用默认值（通常为0或中性值），**不会影响主流程运行**。

### 3. 评分解读

| 总分 | 等级 | 二波概率 | 建议 |
|------|------|---------|------|
| 200+ | 极强 | > 70% | 重点关注 |
| 150-199 | 强 | 50-70% | 关注 |
| 100-149 | 中等 | 30-50% | 谨慎观察 |
| < 100 | 弱 | < 30% | 不建议 |

---

## 🔍 调试与验证

### 查看特征提取日志

运行预测时，系统会自动输出增强特征的提取情况：

```
热度特征: 排名15 (变化+5), 持续3天
概念特征: 5个概念, 主概念涨幅4.5%, 动量7.8%
竞价特征: 强度75.0, 量比2.3, 高开3.2%
```

### 验证数据完整性

检查数据文件是否存在且有效：

```bash
ls -lh data/raw/
```

预期输出（增强特征相关文件）：
- `hot_rank.csv` (数KB - 数MB)
- `concept_component.csv` (数KB - 数MB)
- `concept_bar.csv` (数KB - 数MB)
- `auction_factors.csv` (数KB - 数MB)

---

## 🐛 常见问题

### Q1: 数据下载失败怎么办？

**A**: 检查 BigQuant 账号权限和网络连接。如果某个数据源不可用，可以先使用其他特征进行分析。

### Q2: 预测时没有增强特征日志？

**A**: 
1. 检查 `data/raw/` 目录是否有增强特征数据文件（hot_rank.csv、concept_component.csv等）
2. 检查日志中是否有 "无法加载增强特征服务" 的警告
3. 确认股票代码和日期在数据范围内

### Q3: 如何关闭增强特征？

**A**: 如果需要临时关闭增强特征（例如对比测试），可以将 `enhanced_features_dir` 设为 `None` 或删除/重命名数据文件。系统会自动回退到基础特征。

---

## 📈 效果评估

建议使用以下方式评估增强特征的效果：

1. **回测对比**: 在历史数据上，对比使用/不使用增强特征的准确率
2. **实盘验证**: 跟踪预测结果，记录实际二波表现
3. **特征重要性**: 训练新模型时，查看各特征的重要性排名

---

## 🚀 下一步计划

- **阶段2**: 龙虎榜深度数据（营业部画像、席位类型）
- **阶段3**: 筹码分布进阶（成本集中度、套牢盘）
- **阶段4**: 交易日历智能化（自动跳过节假日）

---

**版本**: Phase 4.1
**最后更新**: 2026-01-13
**作者**: AI Assistant
