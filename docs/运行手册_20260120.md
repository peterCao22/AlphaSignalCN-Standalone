# RUNBOOK_20260120：数据刷新 + 训练 + 异动股池预测（A股短线二波）

## 目标

- 下周一（2026-01-20）在 BigQuant 流量恢复后：
  - **补齐 `kline_all.csv` 缺失字段**（重点 `turn` 换手率 + 其余6列）
  - 更新技术因子 / 增强特征 / 资金流向（可选）
  - 生成训练用股性+量价特征（features 文件）
  - 重新训练模型
  - 进行单股/批量异动股池预测

> 说明：预测脚本 `predict_stock.py` **默认只读** `data/raw/kline/kline_all.csv`；训练脚本 `train_model.py` 会优先读取 `data/raw/features/` 下最新的 `features_kline_stock_character_*.csv`。

---

## 0. 环境准备（PowerShell）

推荐使用项目 venv（避免 conda 环境缺依赖导致 `ModuleNotFoundError`）。

```powershell
cd d:\myCursor\StockAiNews
.\venv\Scripts\Activate.ps1
cd TradingAgents-chinese-market\AlphaSignal-CN
```

---

## 1. 先补齐 K 线缺失字段（7列全补，省流量版）

### 为什么要先做这一步？

- 训练用到的“换手/量价结构”特征质量依赖 `turn`（换手率）等字段；
- 必须在生成 `features_*.csv` 之前补齐，否则 `turnover_rate` 会退化为估算值。

### 执行命令（建议用近3年范围）

```powershell
python scripts/patch_kline_all_missing_columns_from_bigquant.py --start-date 2023-01-01 --end-date 2026-01-14 --batch-days 120
```

会补齐这 7 列并合并回 `data/raw/kline/kline_all.csv`：
- `name`
- `pre_close`
- `deal_number`
- `change_ratio`
- `turn`
- `upper_limit`
- `lower_limit`

### 检查点

- 运行完成后确认 `kline_all.csv` 列是否包含 `turn`：

```powershell
python -c "import pandas as pd; df=pd.read_csv('data/raw/kline/kline_all.csv', nrows=1); print(df.columns.tolist())"
```

---

## 2. 下载/更新外部因子数据（按需）

### 2.1 技术分析因子（TA）

```powershell
python scripts/download_ta_factors.py
```

### 2.2 增强特征（热度/概念/竞价等）

```powershell
python scripts/download_enhanced_features.py
```

### 2.3 资金流向（Moneyflow，可选，可能最容易失败）

> 资金流向数据可能触发 200MB/分区限制；如果失败先跳过，不影响你先训练“104特征版”（不含 moneyflow）。

```powershell
python scripts/download_moneyflow.py
```

---

## 3. 生成训练用股性+量价特征文件（features）

```powershell
python scripts/enhanced_stock_character_features.py
```

输出目录：
- `data/raw/features/`

输出文件名示例：
- `features_kline_stock_character_20260120_090000.csv`

### 检查点

```powershell
python -c "from pathlib import Path; p=Path('data/raw/features'); print([f.name for f in sorted(p.glob('features_kline_stock_character_*.csv'))][-5:])"
```

---

## 4. 重新训练模型

```powershell
python scripts/train_model.py
```

### 训练后检查点

确认模型与特征名文件存在（路径可能根据脚本略有变化，以实际输出为准）：
- `models/second_wave_lgb.model`
- `models/feature_names.json`

---

## 5. 预测：单股 / 批量异动股池

### 5.1 单股

```powershell
python predict_stock.py --symbol 300346
```

### 5.2 批量（涨停股池）

```powershell
python predict_stock.py --batch --force-today
```

---

## 常见问题（FAQ）

### Q1：为什么不建议全量重建 `kline_all.csv`？
- 全量重建会把已有字段再次下载一遍，通常更耗流量；
- 现在采用“补列脚本”只下载缺失字段（7列），更省流量。

### Q2：`train_model.py` 会自动补数据吗？
- 不会。训练脚本只读本地文件/数据库。
- 补K线字段（turn 等）建议手工执行本 Runbook 的第 1 步。

### Q3：moneyflow 下载失败怎么办？
- 先跳过，仍可训练不含 moneyflow 的版本；
- 等配额/限制稳定后再补 moneyflow，并重新训练。

