# æ¨¡å‹æ”¹è¿›å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### Phase 1: å¿«é€Ÿä¿®å¤ï¼ˆâœ… å®Œæˆï¼‰

#### 1.1 è°ƒæ•´é¾™è™æ¦œèµ„é‡‘æƒé‡
**æ–‡ä»¶**: `scripts/pattern_matcher.py`

**ä¿®æ”¹å†…å®¹**:
- å¤§å¹…æå‡é¾™è™æ¦œèµ„é‡‘æƒé‡ï¼š
  - 3äº¿ä»¥ä¸Šï¼š+50åˆ†ï¼ˆåŸ20åˆ†ï¼‰
  - 2äº¿ï¼š+40åˆ†ï¼ˆæ–°å¢ï¼‰
  - 1äº¿ï¼š+30åˆ†ï¼ˆæ–°å¢ï¼‰
  - 5000ä¸‡ï¼š+20åˆ†ï¼ˆä¿æŒï¼‰
  - 1000ä¸‡ï¼š+10åˆ†ï¼ˆä¿æŒï¼‰

#### 1.2 å¢åŠ å¼ºåŠ¿è‚¡ç»„åˆè¯†åˆ«
- è¿æ¿2å¤©+ èµ„é‡‘1äº¿+ï¼š+30åˆ†
- ä½ä½ + èµ„é‡‘5000ä¸‡+ï¼š+25åˆ†

#### 1.3 åŠ¨æ€è°ƒæ•´æƒé‡
- èµ„é‡‘é©±åŠ¨å‹ï¼ˆ>1äº¿ï¼‰ï¼šMLæƒé‡70%ï¼ˆåŸ40%ï¼‰
- æ™®é€šå‹ï¼šä¿æŒåŸæƒé‡ï¼ˆML 40%ï¼‰

#### 1.4 æé«˜å¼ºåº¦åˆ†ä¸Šé™
- ä»100åˆ†æé«˜åˆ°150åˆ†

**é¢„æœŸæ•ˆæœ**: 002202æ¡ˆä¾‹çš„é¢„æµ‹æ¦‚ç‡å°†ä»0.40æå‡è‡³0.55+

---

### Phase 2: æ•°æ®çˆ¬å–ï¼ˆâœ… å®Œæˆï¼‰

#### 2.1 åŒèŠ±é¡ºçƒ­é—¨æ¿å—çˆ¬è™«
**æ–‡ä»¶**: `stockainews/crawlers/tonghuashun/hot_sectors.py`

**åŠŸèƒ½**:
- çˆ¬å–TOP20çƒ­é—¨æ¿å—
- è·å–æ¿å—æ¶¨å¹…ã€é¾™å¤´è‚¡ã€èµ„é‡‘æµå…¥
- æ”¯æŒPlaywrightè‡ªåŠ¨åŒ–

**æ•°æ®å­—æ®µ**:
```python
{
    'rank': 1,
    'sector_name': 'AIåº”ç”¨',
    'sector_gain': 5.23,
    'leader_stock_code': '002202',
    'leader_stock_name': 'é‡‘é£ç§‘æŠ€',
    'leader_gain': 10.01,
    'stock_count': 85,
    'capital_inflow': 2000000000
}
```

#### 2.2 ä¹å’•ä¹è‚¡èµšé’±æ•ˆåº”çˆ¬è™«
**æ–‡ä»¶**: `stockainews/crawlers/legulegu/market_activity.py`

**åŠŸèƒ½**:
- çˆ¬å–å¸‚åœºæ´»è·ƒåº¦ï¼ˆæ¶¨è·Œæ¯”ï¼‰
- è·å–æ¶¨åœå®¶æ•°ã€ä¸­ä½æ•°æ¶¨å¹…
- è‡ªåŠ¨è®¡ç®—æƒ…ç»ªå¾—åˆ†ï¼ˆ0-100ï¼‰

**æ•°æ®å­—æ®µ**:
```python
{
    'market_activity': 71.73,
    'up_count': 3718,
    'limit_up_real_count': 92,
    'median_gain': {'all': 0.68, ...},
    'sentiment_score': 75.0
}
```

---

### Phase 3: æ•°æ®å­˜å‚¨ï¼ˆâœ… å®Œæˆï¼‰

#### 3.1 æ•°æ®åº“è®¾è®¡
**æ–‡ä»¶**: `stockainews/services/market_sentiment_service.py`

**æ•°æ®è¡¨**:
1. `hot_sectors`: çƒ­é—¨æ¿å—æ•°æ®
2. `market_sentiment`: å¸‚åœºæƒ…ç»ªæ•°æ®

**ç´¢å¼•ä¼˜åŒ–**:
- æŒ‰æ—¥æœŸç´¢å¼•
- æŒ‰æ¿å—åç´¢å¼•
- æŒ‰é¾™å¤´è‚¡ä»£ç ç´¢å¼•

#### 3.2 æ•°æ®æœåŠ¡API
**ä¸»è¦æ–¹æ³•**:
- `save_hot_sectors()`: ä¿å­˜æ¿å—æ•°æ®
- `save_market_sentiment()`: ä¿å­˜æƒ…ç»ªæ•°æ®
- `get_stock_sector_info()`: æŸ¥è¯¢è‚¡ç¥¨æ¿å—ä¿¡æ¯
- `get_market_sentiment()`: æŸ¥è¯¢å¸‚åœºæƒ…ç»ª
- `get_hot_sectors()`: è·å–çƒ­é—¨æ¿å—åˆ—è¡¨

---

## ğŸ”„ å¾…å®Œæˆçš„å·¥ä½œ

### Phase 4: ç‰¹å¾é›†æˆï¼ˆé¢„è®¡2å¤©ï¼‰

#### 4.1 æ‰©å±• PatternMatcher ç‰¹å¾
**æ–‡ä»¶**: `scripts/pattern_matcher.py`

**éœ€è¦æ·»åŠ **:
```python
def get_stock_features(self, symbol, date):
    # ... åŸæœ‰ä»£ç  ...
    
    # ã€æ–°å¢ã€‘æ¿å—æ•ˆåº”ç‰¹å¾
    from stockainews.services.market_sentiment_service import MarketSentimentService
    sentiment_service = MarketSentimentService()
    
    sector_info = sentiment_service.get_stock_sector_info(
        stock_code=symbol.split('.')[0],
        trade_date=date.date()
    )
    
    # ã€æ–°å¢ã€‘å¸‚åœºæƒ…ç»ªç‰¹å¾
    market_data = sentiment_service.get_market_sentiment(date.date())
    
    # åˆå¹¶ç‰¹å¾
    features.update({
        # æ¿å—ç‰¹å¾
        'is_hot_sector': sector_info.get('is_hot_sector', False),
        'sector_rank': sector_info.get('sector_rank', 999),
        'sector_gain': sector_info.get('sector_gain', 0),
        'is_sector_leader': sector_info.get('is_sector_leader', False),
        'sector_capital_inflow': sector_info.get('sector_capital_inflow', 0),
        
        # å¸‚åœºæƒ…ç»ªç‰¹å¾
        'market_activity': market_data.get('market_activity', 50),
        'market_limit_up_real': market_data.get('limit_up_real_count', 0),
        'market_sentiment_score': market_data.get('sentiment_score', 50),
        'relative_strength': pct_change / market_data.get('median_gain_all', 1) if market_data.get('median_gain_all', 0) != 0 else 0
    })
    
    return features
```

#### 4.2 ä¼˜åŒ–è¯„åˆ†é€»è¾‘
**æ–‡ä»¶**: `scripts/pattern_matcher.py`

**éœ€è¦æ·»åŠ **:
```python
def calculate_scores(self, features, similar_cases):
    # ... åŸæœ‰è®¡ç®—é€»è¾‘ ...
    
    # ã€æ–°å¢ã€‘æ¿å—æ•ˆåº”åŠ æˆ
    if features.get('is_hot_sector', False):
        if features.get('sector_rank', 999) <= 5:
            strength += 30  # TOP5çƒ­é—¨æ¿å—
        elif features.get('sector_rank', 999) <= 10:
            strength += 20  # TOP10çƒ­é—¨æ¿å—
        
        if features.get('is_sector_leader', False):
            strength += 15  # æ¿å—é¾™å¤´
    
    # ã€æ–°å¢ã€‘å¸‚åœºæƒ…ç»ªåŠ æˆ
    sentiment_score = features.get('market_sentiment_score', 50)
    if sentiment_score > 70:
        strength += 25  # å¼ºåŠ¿å¸‚åœº
        final_prob *= 1.2  # æ¦‚ç‡ä¸Šæµ®20%
    elif sentiment_score > 60:
        strength += 15
        final_prob *= 1.1
    elif sentiment_score < 40:
        strength -= 10  # å¼±åŠ¿å¸‚åœºæ‰£åˆ†
        final_prob *= 0.9
    
    # ã€æ–°å¢ã€‘ç›¸å¯¹å¼ºåº¦åŠ æˆ
    if features.get('relative_strength', 0) > 3.0:  # è·‘èµ¢å¸‚åœº3å€
        strength += 20
    
    # ã€æ–°å¢ã€‘èµ„é‡‘+æ¿å—å…±æŒ¯
    if (features.get('net_buy_amount', 0) > 100000000 and  # 1äº¿ä¸ªè‚¡èµ„é‡‘
        features.get('is_hot_sector', False)):              # çƒ­é—¨æ¿å—
        strength += 30  # å¼ºåŠ¿å…±æŒ¯
    
    return {
        'strength_score': min(strength, 150),  # å·²æé«˜ä¸Šé™
        # ... å…¶ä»–è¿”å›å€¼ ...
    }
```

---

### Phase 5: å®šæ—¶ä»»åŠ¡ï¼ˆé¢„è®¡1å¤©ï¼‰

#### 5.1 æ¯æ—¥æ•°æ®æ›´æ–°è„šæœ¬
**æ–‡ä»¶**: `scripts/update_market_sentiment.py`

**éœ€è¦åˆ›å»º**:
```python
import asyncio
from datetime import datetime
from stockainews.crawlers.tonghuashun.hot_sectors import TonghuashunHotSectorsCrawler
from stockainews.crawlers.legulegu.market_activity import LeguLeguMarketActivityCrawler
from stockainews.services.market_sentiment_service import MarketSentimentService

async def update_daily_sentiment():
    """æ¯æ—¥æ›´æ–°å¸‚åœºæƒ…ç»ªæ•°æ®"""
    print(f"[{datetime.now()}] å¼€å§‹æ›´æ–°å¸‚åœºæƒ…ç»ªæ•°æ®...")
    
    # 1. çˆ¬å–çƒ­é—¨æ¿å—
    sector_crawler = TonghuashunHotSectorsCrawler()
    sectors = await sector_crawler.crawl_hot_sectors()
    
    # 2. çˆ¬å–èµšé’±æ•ˆåº”
    activity_crawler = LeguLeguMarketActivityCrawler()
    market_data = activity_crawler.crawl_market_activity()
    
    # 3. ä¿å­˜åˆ°æ•°æ®åº“
    service = MarketSentimentService()
    service.save_hot_sectors(sectors)
    service.save_market_sentiment(market_data)
    
    print(f"[{datetime.now()}] å¸‚åœºæƒ…ç»ªæ•°æ®æ›´æ–°å®Œæˆï¼")

if __name__ == "__main__":
    asyncio.run(update_daily_sentiment())
```

#### 5.2 Windows ä»»åŠ¡è®¡åˆ’
```bash
# æ¯å¤©15:30æ‰§è¡Œï¼ˆæ”¶ç›˜åï¼‰
schtasks /create /tn "UpdateMarketSentiment" /tr "python d:\myCursor\StockAiNews\scripts\update_market_sentiment.py" /sc daily /st 15:30
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### å¯¹ 002202 çš„æ”¹è¿›æ•ˆæœ

| ç»´åº¦ | åŸæ¨¡å‹ | Phase 1 | Phase 4 å®Œæˆå | æ€»æå‡ |
|------|--------|---------|----------------|--------|
| **é¾™è™æ¦œåŠ åˆ†** | +20åˆ† | +50åˆ† | +50åˆ† | +30åˆ† |
| **å¼ºåŠ¿è‚¡ç»„åˆ** | 0åˆ† | +30åˆ† | +30åˆ† | +30åˆ† |
| **æ¿å—åŠ æˆ** | 0åˆ† | 0åˆ† | +30åˆ†ï¼ˆçƒ­é—¨ï¼‰+30åˆ†ï¼ˆå…±æŒ¯ï¼‰ | +60åˆ† |
| **å¸‚åœºæƒ…ç»ª** | 0åˆ† | 0åˆ† | +25åˆ†ï¼ˆå¼ºåŠ¿å¸‚åœºï¼‰ | +25åˆ† |
| **ç›¸å¯¹å¼ºåº¦** | 0åˆ† | 0åˆ† | +20åˆ† | +20åˆ† |
| **å¼ºåº¦åˆ†** | 55åˆ† | 105åˆ† | 220åˆ†ï¼ˆä¸Šé™150ï¼‰ | +95åˆ† |
| **æ¦‚ç‡è°ƒæ•´** | æ—  | MLæƒé‡â†‘ | Ã—1.2ï¼ˆæƒ…ç»ªåŠ æˆï¼‰ | +20% |
| **æœ€ç»ˆæ¦‚ç‡** | 0.40 | **0.55** | **0.70+** | **+75%** |

### æ•´ä½“æ”¹è¿›ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰ | Phase 1 | Phase 4 å®Œæˆå |
|------|------|---------|----------------|
| **å‡†ç¡®ç‡** | 40-50% | 50-60% | **65-75%** |
| **å¬å›ç‡** | 50% | 65% | **80%+** |
| **AUC** | 0.65-0.70 | 0.72-0.75 | **0.80+** |
| **æ¼æŠ¥ç‡** | 50% | 35% | **<20%** |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰

1. **æµ‹è¯•çˆ¬è™«**:
   ```bash
   # æµ‹è¯•åŒèŠ±é¡ºçƒ­é—¨æ¿å—çˆ¬è™«
   python stockainews/crawlers/tonghuashun/hot_sectors.py
   
   # æµ‹è¯•ä¹å’•ä¹è‚¡èµšé’±æ•ˆåº”çˆ¬è™«
   python stockainews/crawlers/legulegu/market_activity.py
   ```

2. **å®Œæˆ Phase 4**:
   - ä¿®æ”¹ `pattern_matcher.py` æ·»åŠ æ–°ç‰¹å¾
   - ä¿®æ”¹è¯„åˆ†é€»è¾‘æ·»åŠ æ¿å—å’Œæƒ…ç»ªåŠ æˆ

3. **å®Œæˆ Phase 5**:
   - åˆ›å»º `update_market_sentiment.py` è„šæœ¬
   - è®¾ç½®Windowså®šæ—¶ä»»åŠ¡

4. **éªŒè¯æ•ˆæœ**:
   ```bash
   # é‡æ–°æµ‹è¯• 002202
   python predict_stock.py --symbol 002202
   
   # æ‰¹é‡æµ‹è¯•æ˜¨æ—¥æ¶¨åœè‚¡
   python predict_stock.py --batch
   ```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. æ‰‹åŠ¨æ›´æ–°å¸‚åœºæƒ…ç»ªæ•°æ®
```python
import asyncio
from stockainews.crawlers.tonghuashun.hot_sectors import TonghuashunHotSectorsCrawler
from stockainews.crawlers.legulegu.market_activity import LeguLeguMarketActivityCrawler
from stockainews.services.market_sentiment_service import MarketSentimentService

# çˆ¬å–æ•°æ®
sector_crawler = TonghuashunHotSectorsCrawler()
sectors = asyncio.run(sector_crawler.crawl_hot_sectors())

activity_crawler = LeguLeguMarketActivityCrawler()
market_data = activity_crawler.crawl_market_activity()

# ä¿å­˜æ•°æ®
service = MarketSentimentService()
service.save_hot_sectors(sectors)
service.save_market_sentiment(market_data)
```

### 2. æŸ¥è¯¢å¸‚åœºæƒ…ç»ªæ•°æ®
```python
from datetime import date
from stockainews.services.market_sentiment_service import MarketSentimentService

service = MarketSentimentService()

# æŸ¥è¯¢è‚¡ç¥¨æ¿å—ä¿¡æ¯
sector_info = service.get_stock_sector_info('002202', date(2025, 12, 29))
print(f"æ˜¯å¦çƒ­é—¨æ¿å—: {sector_info['is_hot_sector']}")
print(f"æ¿å—æ’å: {sector_info['sector_rank']}")

# æŸ¥è¯¢å¸‚åœºæƒ…ç»ª
market_data = service.get_market_sentiment(date(2025, 12, 29))
print(f"å¸‚åœºæ´»è·ƒåº¦: {market_data['market_activity']:.2f}%")
print(f"æƒ…ç»ªå¾—åˆ†: {market_data['sentiment_score']:.1f}")
```

### 3. æŸ¥è¯¢çƒ­é—¨æ¿å—
```python
sectors = service.get_hot_sectors(date.today(), top_n=10)
for sector in sectors:
    print(f"[{sector['rank']}] {sector['sector_name']} +{sector['sector_gain']:.2f}%")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çˆ¬è™«ç¨³å®šæ€§**:
   - åŒèŠ±é¡ºé¡µé¢å¯èƒ½éœ€è¦è°ƒæ•´é€‰æ‹©å™¨
   - å»ºè®®å…ˆç”¨æœ‰å¤´æ¨¡å¼ï¼ˆheadless=Falseï¼‰æµ‹è¯•
   - å¦‚æœçˆ¬å–å¤±è´¥ï¼Œä¿å­˜æˆªå›¾ç”¨äºè°ƒè¯•

2. **æ•°æ®æ—¶æ•ˆæ€§**:
   - å»ºè®®æ¯å¤©15:30ï¼ˆæ”¶ç›˜åï¼‰æ›´æ–°æ•°æ®
   - ä¹å’•ä¹è‚¡æ•°æ®å¯èƒ½æœ‰å»¶è¿Ÿ

3. **ç‰¹å¾è¿‡æ‹Ÿåˆ**:
   - å¢åŠ ç‰¹å¾åéœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹
   - å»ºè®®ç”¨äº¤å‰éªŒè¯è¯„ä¼°æ•ˆæœ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MODEL_IMPROVEMENT_PLAN.md](./MODEL_IMPROVEMENT_PLAN.md) - å®Œæ•´æ”¹è¿›è®¡åˆ’
- [MARKET_SENTIMENT_DATA_PLAN.md](./MARKET_SENTIMENT_DATA_PLAN.md) - æ•°æ®é›†æˆæ–¹æ¡ˆ

---

**æ›´æ–°æ—¶é—´**: 2026-01-09
**çŠ¶æ€**: Phase 1-3 å·²å®Œæˆï¼ŒPhase 4-5 å¾…å®æ–½

