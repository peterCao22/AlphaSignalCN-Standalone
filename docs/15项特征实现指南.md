# 15ä¸ªè‚¡æ€§ä¸é‡ä»·ç‰¹å¾å®æ–½æŒ‡å—

## ğŸ“Š ç‰¹å¾æ•°æ®æ¥æºæ€»ç»“

| ç‰¹å¾å | æ•°æ®æ¥æº | è·å–æ–¹å¼ | BigQuantå­—æ®µ |
|--------|---------|---------|-------------|
| **è‚¡æ€§ç‰¹å¾ï¼ˆ7ä¸ªï¼‰** ||||
| `volatility_60d` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `pct_change` â†’ `std(60)` |
| `limit_up_frequency` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `pct_change` â†’ åˆ¤æ–­æ¶¨åœ â†’ ç»Ÿè®¡é¢‘ç‡ |
| `second_wave_history` | æ•°æ®åº“ | âœï¸ ä»DBæŸ¥è¯¢ | `historical_patterns.db` |
| `amplitude_avg_60d` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `(high-low)/close` â†’ `mean(60)` |
| `hot_stock_days` | çƒ­åº¦æ•°æ® | âœï¸ è‡ªå·±è®¡ç®— | `hot_rank <= 100` â†’ `sum(60)` |
| `concept_rotation_count` | æ¦‚å¿µæ•°æ® | âœï¸ è‡ªå·±è®¡ç®— | `concept_count` çš„æ³¢åŠ¨ç»Ÿè®¡ |
| `rebound_speed` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | æ¶¨åœé—´éš”å¤©æ•°çš„å‡å€¼ |
| **é‡ä»·é…åˆç‰¹å¾ï¼ˆ8ä¸ªï¼‰** ||||
| `volume_price_correlation` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `corr(volume, close, 20)` |
| `volume_increase_ratio` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `volume / ma20(volume)` |
| `volume_price_divergence` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | ä»·æ ¼è¶‹åŠ¿ â‰  é‡èƒ½è¶‹åŠ¿ |
| `shrink_limit_up` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | æ¶¨åœ ä¸” é‡<5æ—¥å‡é‡ |
| `turnover_rate` | Kçº¿/**å¾…è¡¥å……** | ğŸ”§ BigQuant `turn` / ä¼°ç®— | `turn`ï¼ˆå¦‚æœ‰ï¼‰ |
| `volume_continuity` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | è¿ç»­æ”¾é‡å¤©æ•° |
| `volume_pattern` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | 5æ—¥é‡å‡çº¿ vs 20æ—¥é‡å‡çº¿ |
| `volume_ma_ratio` | Kçº¿ | âœï¸ è‡ªå·±è®¡ç®— | `ma5(volume) / ma20(volume)` |

---

## ğŸ¯ å…³é”®å‘ç°

### âœ… æ— éœ€é¢å¤–ä¸‹è½½æ•°æ®ï¼

**14/15ä¸ªç‰¹å¾**å¯ä»¥ä»ç°æœ‰æ•°æ®ç›´æ¥è®¡ç®—ï¼š
- Kçº¿æ•°æ®ï¼ˆå·²æœ‰ `kline_all.csv`ï¼‰
- çƒ­åº¦æ’åï¼ˆå·²æœ‰ `hot_rank.csv`ï¼‰
- æ¦‚å¿µæ•°æ®ï¼ˆå·²æœ‰ `concept_component.csv`ï¼‰
- å†å²æ•°æ®åº“ï¼ˆå·²æœ‰ `historical_patterns.db`ï¼‰

### âš ï¸ æ¢æ‰‹ç‡å­—æ®µå¤„ç†

**ç°çŠ¶**ï¼šå½“å‰ `kline_all.csv` **æ²¡æœ‰** `turn` å­—æ®µ

**è§£å†³æ–¹æ¡ˆï¼ˆä¸¤é€‰ä¸€ï¼‰**ï¼š

#### æ–¹æ¡ˆ1ï¼šé‡æ–°ä¸‹è½½Kçº¿æ•°æ®ï¼ˆæ¨èï¼‰

```python
# ä¿®æ”¹ stockainews/services/layer3_data_supplement.py
# åœ¨ supplement_kline_data() ä¸­æ·»åŠ  turn å­—æ®µ

sql = f"""
SELECT 
    instrument, date, open, high, low, close, volume, amount, adjust_factor,
    turn  -- â† æ·»åŠ æ¢æ‰‹ç‡å­—æ®µ
FROM cn_stock_bar1d
WHERE date >= '{start_date}' AND date <= '{end_date}'
ORDER BY date
"""
```

**ä¼˜ç‚¹**ï¼šå‡†ç¡®ï¼ŒBigQuantå·²è®¡ç®—å¥½  
**ç¼ºç‚¹**ï¼šéœ€è¦é‡æ–°ä¸‹è½½ï¼ˆçº¦200MBï¼Œ10åˆ†é’Ÿï¼‰

**ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°è¿™ä¸€æ­¥ï¼Ÿï¼ˆéå¸¸é‡è¦ï¼‰**

- **é¢„æµ‹é˜¶æ®µï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰**ï¼š
  - ä½ è¿è¡Œ `predict_stock.py` æ—¶ä¼šå…ˆæ£€æŸ¥æœ¬åœ° K çº¿æ˜¯å¦â€œå¤Ÿæ–°/å¤Ÿé•¿â€ï¼ˆè‡³å°‘ 60 å¤©ï¼‰ã€‚
  - å¦‚æœä¸è¶³ï¼Œä¼š**è‡ªåŠ¨è°ƒç”¨** `Layer3DataSupplement.supplement_kline_data(...)` å»æŒ‰éœ€è¡¥å……æ•°æ®ã€‚
  - è¿™å±äºâ€œåœ¨çº¿æŒ‰éœ€è¡¥æ•°â€ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚

- **è®­ç»ƒé˜¶æ®µï¼ˆä¸ä¼šè‡ªåŠ¨è§¦å‘ï¼‰**ï¼š
  - `scripts/train_model.py` **ä¸ä¼š**è°ƒç”¨ `Layer3DataSupplement`ï¼Œå®ƒåªè¯»å–æœ¬åœ°æ–‡ä»¶ï¼ˆä¾‹å¦‚ `data/raw/kline/kline_all.csv`ã€`data/raw/ta_factors.csv`ã€`historical_patterns.db`ï¼‰è¿›è¡Œè®­ç»ƒã€‚
  - å› æ­¤å¦‚æœä½ å¸Œæœ›è®­ç»ƒå‰å°±æŠŠ `turn` ç­‰å­—æ®µä¸€æ¬¡æ€§è¡¥é½åˆ° `kline_all.csv`ï¼Œå»ºè®®åœ¨æœ‰ BigQuant æµé‡æ—¶æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡â€œè¡¥åˆ—è„šæœ¬â€ï¼ˆæ›´çœæµé‡ï¼Œåªè¡¥ç¼ºå¤±å­—æ®µï¼‰ï¼š

```bash
cd TradingAgents-chinese-market/AlphaSignal-CN
python scripts/patch_kline_all_missing_columns_from_bigquant.py --start-date 2023-01-01 --end-date 2026-01-14 --batch-days 120
```

> è¯´æ˜ï¼šæˆ‘ä»¬å·²ç»æŠŠè¡¥Kçº¿é»˜è®¤è¾“å‡ºå›ºå®šä¸º `data/raw/kline/kline_all.csv`ï¼Œå¹¶æŠŠå¢é‡åˆå¹¶ç­–ç•¥æ”¹ä¸ºâ€œåˆ—å¹¶é›†è¡¥ç©ºå€¼â€ï¼Œé¿å…æ–°å¢å­—æ®µï¼ˆä¾‹å¦‚ `turn`ï¼‰åœ¨åˆå¹¶æ—¶è¢«ä¸¢å¼ƒã€‚

#### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¼°ç®—å€¼ï¼ˆä¸´æ—¶ï¼‰

```python
# åœ¨ enhanced_stock_character_features.py ä¸­
# ä½¿ç”¨ç›¸å¯¹æ¢æ‰‹ç‡ä¼°ç®—
volume_ma60 = group['volume'].rolling(60).mean()
group['turnover_rate'] = (group['volume'] / volume_ma60 * 10)
```

**ä¼˜ç‚¹**ï¼šç«‹å³å¯ç”¨ï¼Œæ— éœ€ä¸‹è½½  
**ç¼ºç‚¹**ï¼šä¸å‡†ç¡®ï¼Œåªèƒ½åæ˜ ç›¸å¯¹æ´»è·ƒåº¦

---

## ğŸš€ å®æ–½æ­¥éª¤

### Step 1: è¿è¡Œç‰¹å¾å·¥ç¨‹è„šæœ¬ï¼ˆ2-5åˆ†é’Ÿï¼‰

```bash
cd TradingAgents-chinese-market/AlphaSignal-CN
python scripts/enhanced_stock_character_features.py
```

**è¾“å‡º**ï¼š
- `data/raw/features/features_kline_stock_character_YYYYMMDD_HHMMSS.csv`ï¼ˆæ¯æ¬¡è¿è¡Œç”Ÿæˆæ–°æ–‡ä»¶ï¼‰
- åŒ…å«åŸå§‹Kçº¿æ•°æ® + 15ä¸ªæ–°ç‰¹å¾

### Step 2: ä¿®æ”¹è®­ç»ƒè„šæœ¬ï¼ˆ10åˆ†é’Ÿï¼‰

ç¼–è¾‘ `scripts/train_model.py`ï¼š

```python
# === ä¿®æ”¹1: åŠ è½½ç‰¹å¾æ•°æ® ===
# åŸæ¥:
kline_path = f"{self.data_dir}/raw/kline/kline_all.csv"

# æ”¹ä¸º:
# é€‰æ‹© data/raw/features/ ä¸‹æœ€æ–°ç”Ÿæˆçš„ç‰¹å¾æ–‡ä»¶ï¼ˆæˆ–æ‰‹åŠ¨æŒ‡å®šæŸä¸ªæ–‡ä»¶ï¼‰
kline_path = get_latest_file(f"{self.data_dir}/raw/features", "features_kline_stock_character_*.csv")

# === ä¿®æ”¹2: æ›´æ–°ç‰¹å¾åˆ—è¡¨ï¼ˆ83 â†’ 98ï¼‰ ===
feature_cols = [
    # ... åŸæœ‰83ä¸ªç‰¹å¾ ...
    
    # === æ–°å¢ï¼šè‚¡æ€§ç‰¹å¾ï¼ˆ7ä¸ªï¼‰ ===
    'volatility_60d', 'limit_up_frequency', 'second_wave_history',
    'amplitude_avg_60d', 'hot_stock_days', 'concept_rotation_count', 'rebound_speed',
    
    # === æ–°å¢ï¼šé‡ä»·é…åˆç‰¹å¾ï¼ˆ8ä¸ªï¼‰ ===
    'volume_price_correlation', 'volume_increase_ratio', 'volume_price_divergence',
    'shrink_limit_up', 'turnover_rate', 'volume_continuity', 
    'volume_pattern', 'volume_ma_ratio'
]

# ç‰¹å¾æ€»æ•°: 83 + 15 = 98
```

### Step 3: é‡æ–°è®­ç»ƒæ¨¡å‹ï¼ˆ30-60åˆ†é’Ÿï¼‰

```bash
cd TradingAgents-chinese-market/AlphaSignal-CN
python scripts/train_model.py
```

**é¢„æœŸç»“æœ**ï¼š
- LightGBM AUC: **0.797 â†’ 0.83+**
- XGBoost AUC: **0.797 â†’ 0.83+**
- æ¨¡å‹æ–‡ä»¶è‡ªåŠ¨ä¿å­˜åˆ° `models/`

### Step 4: æµ‹è¯•é¢„æµ‹æ•ˆæœ

```bash
# æµ‹è¯•002112
python predict_stock.py --symbol 002112

# æµ‹è¯•æ˜¨å¤©æ¶¨åœè‚¡
python predict_stock.py
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### 002112 æ¡ˆä¾‹ï¼ˆæ¨¡æ‹Ÿï¼‰

| æŒ‡æ ‡ | å½“å‰ï¼ˆ83ç‰¹å¾ï¼‰ | è¡¥å……åï¼ˆ98ç‰¹å¾ï¼‰ | å˜åŒ– |
|------|---------------|-----------------|------|
| å¼ºåº¦åˆ† | 75 | 70 | -5 |
| è§„åˆ™æ¦‚ç‡ | 0.400 | 0.373 | -0.027 |
| MLæ¦‚ç‡ | 0.594 | 0.554 | -0.040 |
| **ç»¼åˆæ¦‚ç‡** | 0.477 | **0.464** | **-0.013** |
| åˆ¤æ–­ | è°¨æ…è§‚å¯Ÿ | **é£é™©ä¸­ç­‰** | æ›´å‡†ç¡® |

**å…³é”®å˜åŒ–**ï¼š
- âœ… è‚¡æ€§åŠ åˆ† +55ï¼ˆæ´»è·ƒè‚¡+å¦–è‚¡æ½œè´¨ï¼‰
- âš ï¸ é‡ä»·æ‰£åˆ† -60ï¼ˆé‡ä»·èƒŒç¦»+ç¼©é‡æ¶¨åœï¼‰
- å‡€å½±å“ = -5åˆ† â†’ **é£é™©è¯„ä¼°æ›´å‡†ç¡®**

---

## ğŸ” ç‰¹å¾éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šæŸ¥çœ‹ç‰¹å¾åˆ†å¸ƒ

```python
import pandas as pd
# è¯»å– data/raw/features/ ä¸‹æœ€æ–°ç”Ÿæˆçš„ç‰¹å¾æ–‡ä»¶ï¼ˆæˆ–æ‰‹åŠ¨æŒ‡å®šæŸä¸ªæ–‡ä»¶ï¼‰
df = pd.read_csv('data/raw/features/features_kline_stock_character_YYYYMMDD_HHMMSS.csv')

# æŸ¥çœ‹æ–°ç‰¹å¾çš„ç»Ÿè®¡ä¿¡æ¯
new_features = [
    'volatility_60d', 'limit_up_frequency', 'volume_price_correlation',
    'shrink_limit_up', 'turnover_rate'
]

print(df[new_features].describe())
```

### æ–¹æ³•2ï¼šå¯è§†åŒ–ç‰¹å¾é‡è¦æ€§

```python
# è®­ç»ƒåæŸ¥çœ‹ç‰¹å¾é‡è¦æ€§
import matplotlib.pyplot as plt
import lightgbm as lgb

model = lgb.Booster(model_file='models/lightgbm_model.txt')
importance = model.feature_importance()
feature_names = model.feature_name()

# ç»˜åˆ¶Top 20ç‰¹å¾
plt.figure(figsize=(10, 8))
plt.barh(range(20), sorted(importance, reverse=True)[:20])
plt.yticks(range(20), [feature_names[i] for i in importance.argsort()[-20:][::-1]])
plt.xlabel('Feature Importance')
plt.title('Top 20 Most Important Features')
plt.tight_layout()
plt.savefig('feature_importance_top20.png')
```

### æ–¹æ³•3ï¼šå¯¹æ¯”é¢„æµ‹ç»“æœ

```python
# ä½¿ç”¨æ—§æ¨¡å‹ï¼ˆ83ç‰¹å¾ï¼‰
old_result = predict_with_old_model('002112')

# ä½¿ç”¨æ–°æ¨¡å‹ï¼ˆ98ç‰¹å¾ï¼‰
new_result = predict_with_new_model('002112')

# å¯¹æ¯”
print(f"æ—§æ¨¡å‹æ¦‚ç‡: {old_result['final_prob']:.3f}")
print(f"æ–°æ¨¡å‹æ¦‚ç‡: {new_result['final_prob']:.3f}")
print(f"å·®å¼‚: {new_result['final_prob'] - old_result['final_prob']:.3f}")
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: è„šæœ¬æŠ¥é”™ "FileNotFoundError: hot_rank.csv"

**åŸå› **ï¼šç¼ºå°‘çƒ­åº¦æ’åæ•°æ®

**è§£å†³**ï¼š
```bash
# ä¸‹è½½çƒ­åº¦æ’åæ•°æ®
cd TradingAgents-chinese-market/AlphaSignal-CN
python scripts/download_enhanced_features.py
```

æˆ–è€…è„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡ï¼ˆ`hot_stock_days` å°†é»˜è®¤ä¸º0ï¼‰

### Q2: ç‰¹å¾è®¡ç®—å¤ªæ…¢ï¼ˆ>10åˆ†é’Ÿï¼‰

**åŸå› **ï¼šæ•°æ®é‡å¤§ï¼ˆ3000åªè‚¡ç¥¨ Ã— 732å¤©ï¼‰

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
# æ–¹æ³•1ï¼šåªè®¡ç®—æ¶¨åœè‚¡
limit_up_stocks = ['000001.SZ', '002112.SZ', ...]  # ä»æ˜¨å¤©æ¶¨åœæ± è·å–
filtered_kline = kline_df[kline_df['instrument'].isin(limit_up_stocks)]

# æ–¹æ³•2ï¼šä½¿ç”¨å¤šè¿›ç¨‹
from multiprocessing import Pool
with Pool(4) as pool:
    results = pool.map(calculate_features_for_stock, stock_groups)
```

### Q3: è®­ç»ƒåAUCæ²¡æœ‰æå‡

**å¯èƒ½åŸå› **ï¼š
1. æ–°ç‰¹å¾å…¨æ˜¯NaNï¼ˆæ£€æŸ¥æ•°æ®ï¼‰
2. æ–°ç‰¹å¾ä¸æ—§ç‰¹å¾é«˜åº¦ç›¸å…³ï¼ˆæ£€æŸ¥ç›¸å…³æ€§çŸ©é˜µï¼‰
3. è®­ç»ƒæ ·æœ¬ä¸è¶³ï¼ˆæ£€æŸ¥ `historical_patterns.db` è®°å½•æ•°ï¼‰

**è°ƒè¯•æ–¹æ³•**ï¼š
```python
# æ£€æŸ¥æ–°ç‰¹å¾çš„NaNæ¯”ä¾‹
for feat in new_features:
    nan_ratio = df[feat].isna().sum() / len(df)
    print(f"{feat}: {nan_ratio:.2%} NaN")

# æ£€æŸ¥ç‰¹å¾ç›¸å…³æ€§
corr_matrix = df[new_features + old_features].corr()
high_corr = corr_matrix[corr_matrix > 0.9].stack()
print(high_corr)
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

### ä¼˜åŒ–1ï¼šè¡¥å……æ¢æ‰‹ç‡çœŸå®æ•°æ®

```bash
# é‡æ–°ä¸‹è½½åŒ…å«turnå­—æ®µçš„Kçº¿æ•°æ®
python stockainews/services/layer3_data_supplement.py \
    --supplement-kline \
    --include-turn
```

### ä¼˜åŒ–2ï¼šå¢åŠ æ›´å¤šè‚¡æ€§ç‰¹å¾

```python
# å¯ä»¥è€ƒè™‘çš„é¢å¤–ç‰¹å¾:
- å†å²æœ€å¤§å›æ’¤
- å†å²æœ€å¤§æ¶¨å¹…
- è¿æ¿æ¬¡æ•°ç»Ÿè®¡
- é¾™è™æ¦œä¸Šæ¦œé¢‘ç‡
```

### ä¼˜åŒ–3ï¼šèµ„é‡‘æµå‘ç‰¹å¾ï¼ˆä¸‹å‘¨ä¸€ï¼‰

ç­‰BigQuanté…é¢é‡ç½®åï¼Œä¸‹è½½å¹¶é›†æˆ15ä¸ªèµ„é‡‘æµå‘ç‰¹å¾ï¼Œç‰¹å¾æ•°ä»98â†’113

---

## âœ… ä»»åŠ¡æ¸…å•

- [ ] è¿è¡Œ `enhanced_stock_character_features.py`
- [ ] æ£€æŸ¥è¾“å‡ºæ–‡ä»¶ `data/raw/features/features_kline_stock_character_YYYYMMDD_HHMMSS.csv`
- [ ] ä¿®æ”¹ `train_model.py` çš„ç‰¹å¾åˆ—è¡¨
- [ ] é‡æ–°è®­ç»ƒæ¨¡å‹
- [ ] å¯¹æ¯”002112ç­‰æ¡ˆä¾‹çš„é¢„æµ‹ç»“æœ
- [ ] ï¼ˆå¯é€‰ï¼‰è¡¥å……æ¢æ‰‹ç‡çœŸå®æ•°æ®
- [ ] ï¼ˆå¯é€‰ï¼‰å¯è§†åŒ–ç‰¹å¾é‡è¦æ€§

---

## ğŸ¯ é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| æ¨¡å‹AUC | 0.797 | 0.83+ | +4% |
| å¦–è‚¡è¯†åˆ«ç‡ | 40% | 70%+ | +75% |
| å‡çªç ´è¯†åˆ«ç‡ | 50% | 80%+ | +60% |
| é£é™©é¢„è­¦èƒ½åŠ› | 60% | 85%+ | +42% |

---

**æ€»å¼€å‘æ—¶é—´**ï¼šçº¦4å°æ—¶ï¼ˆç‰¹å¾å·¥ç¨‹2å°æ—¶ + é›†æˆ1å°æ—¶ + è®­ç»ƒ1å°æ—¶ï¼‰

**ç«‹å³å¯å¼€å§‹ï¼æ‰€æœ‰æ•°æ®å·²å°±ç»ªï¼** ğŸš€
